(function(){function x(r){Object.defineProperty(r,"__esModule",{value:!0,configurable:!0})}function y(r,g,s,l){Object.defineProperty(r,g,{get:s,set:l,enumerable:!0,configurable:!0})}var W=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{},t=W.parcelRequire94c2,w=t.register;w("dnUNq",function(r,g){x(r.exports),y(r.exports,"default",function(){return E});var s=t("eSOI5"),l=t("kCbDV"),d=t("jNfr7"),e=t("a78DZ"),c=t("6QfcD"),o=t("izL3O"),a=t("7Tj0o"),I=t("kK0IS"),b=t("bkGGB"),i=t("519R9"),n=t("aEodP"),u=t("jWPpp");class h{constructor(){this.account=b.default,this.rules=new e.default,this.appKey=(0,c.getAppKey)()}getBubbleSettings=async()=>{const p=window.location.href,f=(0,o.getShop)()||window.Shopify?.shop;if(!this.appKey&&!f)return;const $=(0,s.getIdentifyInfoId)(),m=this.rules.getTolstoyViewers(),v=f||window.location.host,P={timestamp:Date.now(),url:p,sessionCount:Number((0,s.getSessionCounter)()||0),lastSeenAt:new Date().toISOString(),firstSeenAt:(0,s.getFirstSeenAt)(),tolstoySeenCounter:m,isMobile:a.default.isMobile(),domain:v,appUrl:f,appKey:this.appKey};$&&(P.identifyInfoId=$);try{const D=await(0,I.getBubbleSettings)(P);return D?(this.rules.updateRules(D),D):null}catch{return null}};init=async()=>{if(!this.account?.hasLiveBubble)return;const p=await this.getBubbleSettings();this.subscribeToUrlChange();const f=window.tolstoyWidgetId||p?.publishId||p?.exitIntentPublishId;if(!f){this.widget?.hide?.();return}if(!window.tolstoySettings?.alwaysShow&&(0,s.getTolstoyHideWidget)(f)==="true")return;const m=(0,d.getWidgetNameById)(f);let v;m===l.CENTERED_MODAL_WIDGET?v=await t("enQtM"):m===l.BUBBLE_WIDGET&&(v=await t("bQxIb")),await(0,u.commonLoader)(),this.widget?(this.widget.recreate(f,m),this.widget.show()):(this.widget=new d.default,await this.widget.init({bubbleSettings:p,widgetId:f,Component:v.default}))};handleUrlChange=()=>{this.unsubscribeFromUrlChange(),this.init()};subscribeToUrlChange(){i.default.subscribe({eventName:n.INTERNAL_EVENTS.urlChange,callback:this.handleUrlChange})}unsubscribeFromUrlChange(){i.default.unsubscribe({eventName:n.INTERNAL_EVENTS.urlChange,callback:this.handleUrlChange})}}var E=h}),w("jNfr7",function(r,g){y(r.exports,"getWidgetNameById",function(){return c}),y(r.exports,"default",function(){return I});var s=t("eSOI5"),l=t("kCbDV");const d=l.BUBBLE_WIDGET,e=new Set(["5bzilmwoe1fon","z7uu0kcyzumt0"]),c=b=>e.has(b)?l.CENTERED_MODAL_WIDGET:d;class o{constructor(){this.initialized=!1,this.widgets=[],this.start=this.start.bind(this),this.startPart=this.startPart.bind(this),this.hide=this.hide.bind(this),this.show=this.show.bind(this),this.on=this.on.bind(this),this.recreate=this.recreate.bind(this),window.tolstoyWidget={...window.tolstoyWidget,start:this.start,startPart:this.startPart,show:this.show,hide:this.hide,on:this.on,recreate:this.recreate}}async init({bubbleSettings:i,widgetId:n,Component:u}){this.bubbleSettings=i;const h=new u(i);if(await h.init(),this.widgets.push(h),this.updateViewerIdentifyAttributes(),window.tolstoySettings?.noReload||this.registerEvents(),(window.tolstoySettings?.alwaysShow||(0,s.getTolstoyHideWidget)(n)!=="true")&&!i.exitIntentPublishId){const S=c(n);this.show(S),this.recreate(n,S)}else this.hide()}updateViewerIdentifyAttributes(){const i=Number((0,s.getSessionCounter)()||0)+1;(0,s.setSessionCounter)(i.toString()),(0,s.getFirstSeenAt)()||(0,s.setFirstSeenAt)(new Date().toISOString())}handleMouseDown(){this.userInteracted=!0,document.removeEventListener("mousedown",this.handleMouseDown)}registerEvents(){document.addEventListener("mousedown",()=>{this.handleMouseDown()}),document.body.addEventListener("mouseleave",async()=>{const i=this.bubbleSettings?.exitIntentPublishId;if(i&&this.userInteracted){const u=this.widgets.find(h=>h?.bubbleSettings?.exitIntentPublishId);u&&await this.recreate(i,u.name,{startPlayerImmediately:!0})}})}start(i=d){const n=a(this.widgets,i);n&&n.start()}startPart(i,n=d){const u=a(this.widgets,n);u&&u.startPart(i)}hide(i=d){const n=a(this.widgets,i);n&&n.hide()}show(i=d){const n=a(this.widgets,i);n&&n.show()}on(i,n,u=d){const h=a(this.widgets,u);h&&h.eventChange(i,n)}recreate(i,n=d,u={}){const h=a(this.widgets,n);h&&h.recreate(i,u)}}const a=(b,i)=>b.find(n=>n.name===i);var I=o}),w("7Tj0o",function(r,g){y(r.exports,"default",function(){return l});class s{static isValidUrl(e){return e?e.startsWith("tel:")||e.startsWith("mailto:")?!0:e.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_+.~#?&//=]*)/g)!==null:!1}static isAndroid(){return navigator.userAgent.toLowerCase().indexOf("android")>-1}static isInIframe(){try{return window.self!==window.top}catch{return!0}}static isIos(){return/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}static getMobileOperatingSystem(){const e=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(e)?"Windows Phone":/android/i.test(e)?"Android":/iPad|iPhone|iPod/.test(e)&&!window.MSStream?"iOS":navigator.userAgent.match(/Mac/)&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2?"ipad":null}static isMobile(){return s.getMobileOperatingSystem()!=null}static isSafari(){return window.safari!==void 0}static enforceProtocol(e,c="https"){return e.startsWith("http")||e.startsWith("//")||e.startsWith("tel:")||e.startsWith("mailto:")?e:`${c}://${e}`}static removeProtocol(e){return e.replace(/(^\w+:|^)\/\//,"")}static stripUrl(e){return s.removeProtocol(e).replace(/^www./,"").replace(/\/$/,"")}static stringifyUrlParams(e){const c=new URLSearchParams;return Object.entries(e).forEach(([o,a])=>{c.set(o,a)}),c.toString()}}var l=s}),w("enQtM",function(r,g){r.exports=Promise.all([t("9FDC1")(t("jHnDr").resolve("isfCu")),t("1rN27")(t("jHnDr").resolve("cDpG9")),t("1rN27")(t("jHnDr").resolve("aKM9X"))]).then(()=>t("4FBx6"))}),w("9FDC1",function(r,g){"use strict";var s=t("JNMYe");r.exports=s(function(l){return new Promise(function(d,e){var c=document.getElementsByTagName("link");if([].concat(c).some(function(a){return a.href===l&&a.rel.indexOf("stylesheet")>-1})){d();return}var o=document.createElement("link");o.rel="stylesheet",o.href=l,o.onerror=function(a){o.onerror=o.onload=null,o.remove(),e(a)},o.onload=function(){o.onerror=o.onload=null,d()},document.getElementsByTagName("head")[0].appendChild(o)})})}),w("bQxIb",function(r,g){r.exports=Promise.all([t("9FDC1")(t("jHnDr").resolve("koqqC")),t("1rN27")(t("jHnDr").resolve("cDpG9")),t("1rN27")(t("jHnDr").resolve("b9uE3"))]).then(()=>t("9Du8u"))})})();
